---
groups:
- name: eirini
  jobs:
  - bump-eirini

resources:
- name: cf-for-k8s-develop
  type: git
  icon: github-box
  source:
    branch: wip-bump-eirini-171631154
    uri: git@github.com:cloudfoundry/cf-for-k8s
    private_key: ((cf_for_k8s_readonly_deploy_key.private_key))
    ignore_paths:
      - ci/**

- name: cf-for-k8s-develop-ci
  type: git
  icon: github-box
  source:
    branch: wip-bump-eirini-171631154
    uri: git@github.com:cloudfoundry/cf-for-k8s
    private_key: ((cf_for_k8s_readonly_deploy_key.private_key))
    paths:
      - ci/**

- name: eirini-release
  type: github-release
  source:
    owner: cloudfoundry-incubator
    repository: eirini-release
    access_token: ((cf_deployment_release_bot_access_token))

- name: ready-pool
  type: pool
  icon: pool
  source:
    uri: git@github.com:cloudfoundry/relint-ci-pools
    branch: master
    pool: k8s-dev/ready
    private_key: ((relint_ci_pools_readwrite_deploy_key.private_key))

# Extract common platform and image_resource details so task configs can be more concise
x-config: &common-task-config
  platform: linux
  image_resource:
    type: docker-image
    source:
      repository: relintdockerhubpushbot/cf-for-k8s-ci

jobs:
- name: bump-eirini
  public: true
  plan:
    - in_parallel:
        - get: cf-for-k8s-develop-ci
        - get: cf-for-k8s-develop
        - get: eirini-release
          trigger: true
        - put: ready-pool
          params: {acquire: true}

    - task: bump-eirini
      config:
        <<: *common-task-config
        inputs:
          - name: cf-for-k8s-develop
          - name: eirini-release
        outputs:
          - name: cf-for-k8s-bump
        run:
          path: /bin/bash
          args:
            - -ec
            - |
              TAG=$(cat eirini-release/tag)
              pushd cf-for-k8s-develop > /dev/null
                cat <<EOT > /tmp/bump-eirini-overlay.yml
              #@ load("@ytt:overlay", "overlay")

              #@overlay/match by=overlay.subset({})
              ---
              directories:
              #@overlay/match by="path"
              - path: build/eirini/_vendir
                contents:
                  #@overlay/match by="path"
                  - path: .
                    githubRelease:
                      #@overlay/replace
                      tag: ${TAG}
              EOT
                ytt -f vendir.yml -f /tmp/bump-eirini-overlay.yml --ignore-unknown-comments=true > /tmp/vendir.yml && cp /tmp/vendir.yml vendir.yml
                vendir sync
              popd > /dev/null
              cp -r cf-for-k8s-develop/* cf-for-k8s-bump/


    - task: run-unit-tests
      file: cf-for-k8s-develop-ci/ci/tasks/run-unit-tests/task.yml
      input_mapping:
        cf-for-k8s-ci: cf-for-k8s-develop-ci
        cf-for-k8s-repo: cf-for-k8s-bump

    - task: install-cf
      file: cf-for-k8s-develop-ci/ci/tasks/install-cf-on-gke/task.yml
      input_mapping:
        cf-for-k8s-candidate: cf-for-k8s-bump
        pool-lock: ready-pool

    - task: run-smoke-tests
      file: cf-for-k8s-develop-ci/ci/tasks/run-smoke-tests/task.yml
      input_mapping:
        cf-for-k8s-master: cf-for-k8s-bump
